#!/bin/bash

# ===========================================
# Pre-commit hook: セキュリティチェック
# 機密情報が含まれている場合コミットをブロック
# ===========================================

echo "🔍 セキュリティチェック実行中..."

# 色の定義
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# エラーフラグ
ERRORS_FOUND=0

# ステージングされたファイルを取得
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "✅ チェック対象ファイルなし"
    exit 0
fi

# ===========================================
# チェックパターン定義
# ===========================================

# APIキーパターン
API_KEY_PATTERNS=(
    "sk-proj-[a-zA-Z0-9_-]{20,}"           # OpenAI API Key
    "sk-[a-zA-Z0-9]{48}"                    # OpenAI API Key (old format)
    "AIzaSy[a-zA-Z0-9_-]{33}"               # Google/Gemini API Key
    "sk_live_[a-zA-Z0-9]{24,}"              # Stripe Live Key
    "sk_test_[a-zA-Z0-9]{24,}"              # Stripe Test Key
    "ghp_[a-zA-Z0-9]{36}"                   # GitHub Personal Access Token
    "gho_[a-zA-Z0-9]{36}"                   # GitHub OAuth Token
    "github_pat_[a-zA-Z0-9_]{22,}"          # GitHub Fine-grained PAT
    "xoxb-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}"  # Slack Bot Token
    "xoxp-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}"  # Slack User Token
    "AKIA[0-9A-Z]{16}"                      # AWS Access Key ID
    "eyJ[a-zA-Z0-9_-]*\.eyJ[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*"  # JWT Token (長いもののみ)
)

# 禁止メールアドレスパターン（実際のメールアドレス）
FORBIDDEN_EMAILS=(
    "atarashixatarashi@gmail.com"
    "@gmail.com"
    "@yahoo.co.jp"
    "@outlook.com"
    "@hotmail.com"
)

# 許可されたメールアドレス（除外パターン）
ALLOWED_EMAILS=(
    "noreply@anthropic.com"
    "noreply@github.com"
    "@users.noreply.github.com"
    "example@example.com"
    "test@test.com"
)

# Supabase service_role key パターン
SUPABASE_SERVICE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\.[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+"

# ===========================================
# チェック関数
# ===========================================

check_file() {
    local file=$1
    local content=$(git show ":$file" 2>/dev/null)

    if [ -z "$content" ]; then
        return 0
    fi

    # APIキーチェック
    for pattern in "${API_KEY_PATTERNS[@]}"; do
        if echo "$content" | grep -qE "$pattern"; then
            echo -e "${RED}❌ エラー: APIキーが検出されました${NC}"
            echo "   ファイル: $file"
            echo "   パターン: $pattern"
            ERRORS_FOUND=1
        fi
    done

    # Supabase service_role keyチェック
    if echo "$content" | grep -qE "$SUPABASE_SERVICE_KEY"; then
        # anon keyは許可、service_role keyのみブロック
        if echo "$content" | grep -qi "service_role"; then
            echo -e "${RED}❌ エラー: Supabase service_role キーが検出されました${NC}"
            echo "   ファイル: $file"
            ERRORS_FOUND=1
        fi
    fi

    # メールアドレスチェック
    for email_pattern in "${FORBIDDEN_EMAILS[@]}"; do
        matches=$(echo "$content" | grep -oE "[a-zA-Z0-9._%+-]+${email_pattern}" | head -5)
        if [ -n "$matches" ]; then
            # 許可リストをチェック
            is_allowed=0
            for allowed in "${ALLOWED_EMAILS[@]}"; do
                if echo "$matches" | grep -q "$allowed"; then
                    is_allowed=1
                    break
                fi
            done

            if [ $is_allowed -eq 0 ]; then
                echo -e "${YELLOW}⚠️  警告: 実際のメールアドレスが検出されました${NC}"
                echo "   ファイル: $file"
                echo "   検出: $matches"
                echo "   → noreply アドレスの使用を推奨します"
                # メールアドレスは警告のみ（ブロックしない場合はコメントアウト）
                # ERRORS_FOUND=1
            fi
        fi
    done
}

# ===========================================
# メイン処理
# ===========================================

for file in $STAGED_FILES; do
    # バイナリファイルをスキップ
    if file "$file" 2>/dev/null | grep -q "binary"; then
        continue
    fi

    # 特定の拡張子のみチェック
    case "$file" in
        *.js|*.ts|*.tsx|*.jsx|*.json|*.env*|*.yml|*.yaml|*.md|*.txt|*.py|*.sh|*.html|*.css)
            check_file "$file"
            ;;
        *)
            # 拡張子なしまたは不明なファイルもチェック
            if [ -f "$file" ]; then
                check_file "$file"
            fi
            ;;
    esac
done

# ===========================================
# 結果出力
# ===========================================

if [ $ERRORS_FOUND -eq 1 ]; then
    echo ""
    echo -e "${RED}=========================================${NC}"
    echo -e "${RED}❌ コミットがブロックされました${NC}"
    echo -e "${RED}=========================================${NC}"
    echo ""
    echo "機密情報を削除してから再度コミットしてください。"
    echo ""
    echo "強制的にコミットする場合（非推奨）:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo "✅ セキュリティチェック完了 - 問題なし"
exit 0
